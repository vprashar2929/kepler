name: Release

on: # yamllint disable-line rule:truthy
  workflow_dispatch:
    inputs:
      tag:
        description: Tag for release (e.g., 1.0.0)
        required: true

jobs:
  release:
    permissions:
      contents: write
      pull-requests: write

    runs-on: ubuntu-latest
    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5.4.0
        with:
          go-version-file: go.mod
          cache: true

      - name: Login to Quay
        uses: docker/login-action@v2
        with:
          # registry: quay.io/sustainable_computing_io
          registry: quay.io/rh_ee_vprashar
          username: ${{ secrets.username }}
          password: ${{ secrets.password }}
          # username: ${{ secrets.BOT_NAME }}
          # password: ${{ secrets.BOT_TOKEN }}

      - name: Set Git user
        run: |
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"

      - name: Create release branch
        run: |
          git checkout -b release-${{ github.event.inputs.tag }}

      - name: Get previous tag
        id: prev_tag
        run: |
          git fetch --tags
          PREV_TAG=$(git tag --sort=-v:refname | sed -n '1p')
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: mikepenz/release-changelog-builder-action@v5
        with:
          fromTag: ${{ steps.prev_tag.outputs.tag }}
          toTag: ${{ github.event.inputs.tag }}
          mode: COMMIT
          configurationJson: |
              {
                "template": "#{{CHANGELOG}}",
                "categories": [
                  {
                    "title": "## Features",
                    "labels": ["feat"]
                  },
                  {
                    "title": "## Fixes",
                    "labels": ["fix"]
                  },
                ],
                "label_extractor": [
                  {
                    "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test|compose){1}(\\([\\w\\-\\.]+\\))?(!)?: ([\\w ])+([\\s\\S]*)",
                    "on_property": "title",
                    "target": "$1"
                  }
                ],
                "pr_template": "#{{NUMBER}} {{TITLE}}"
              }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Print changelog
        run: |
          echo "changelog=${{ steps.changelog.outputs.changelog }}" >> $GITHUB_OUTPUT

      - name: Build image
        run: make image
        env:
          IMG_BASE: quay.io/rh_ee_vprashar

      - name: Push image
        run: make push
        env:
          IMG_BASE: quay.io/rh_ee_vprashar

      - name: Tag release branch
        run: |
          git tag -a v${{ github.event.inputs.tag }} -m "Release ${{ github.event.inputs.tag }}"

      - name: Push release branch with tag
        run: |
          git push origin release-${{ github.event.inputs.tag }}
          git push origin v${{ github.event.inputs.tag }}

      - name: Create GitHub release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.event.inputs.tag }}
          name: release-${{ github.event.inputs.tag }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
